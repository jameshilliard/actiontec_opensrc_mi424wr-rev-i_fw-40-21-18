RGSRC=../../../
include $(RGSRC)/envir.mak
include $(PWD_SRC)/crypto_env.mak

COMMON_SUBDIRS+=$(if $(CONFIG_RG_OPENSSL_MD5),md5)
COMMON_SUBDIRS+=$(if $(CONFIG_RG_OPENSSL_SHA),sha)
COMMON_SUBDIRS+=$(if $(CONFIG_RG_OPENSSL_DES),des)
COMMON_SUBDIRS+=$(if $(CONFIG_RG_OPENSSL_MD4),md4)

CRYPTO_LIB_SUBDIRS=stack err bio lhash buffer rand bn ripemd rsa dsa dso dh \
  objects evp asn1 pem x509 x509v3 conf txt_db pkcs7 pkcs12 comp \
  rc4 hmac rc2 aes ui ocsp pqueue md2 $(if $(CONFIG_RG_OPENSSL_BLOWFISH),bf) \
  $(if $(CONFIG_RG_OPENSSL_CAST),cast)

# all directories are entered just to export their headers
ARCHCONFIG_SUBDIRS=$(COMMON_SUBDIRS) $(CRYPTO_LIB_SUBDIRS)

A_TARGET:=$(notdir $(A_TARGET))

ifndef CONFIG_RG_CRYPTO
  SUBDIRS=$(COMMON_SUBDIRS)
  O_OBJS_$(A_TARGET)=crypto_stubs.o mem_clr.o
else
  SUBDIRS=$(COMMON_SUBDIRS) $(CRYPTO_LIB_SUBDIRS)
  O_OBJS_$(A_TARGET)=cryptlib.o mem.o mem_clr.o mem_dbg.o cversion.o \
	  ex_data.o tmdiff.o cpt_err.o ebcdic.o uid.o o_time.o o_str.o o_dir.o
endif

ifdef CONFIG_DYN_LINK
  SO_TARGET=$(A_TARGET:%.a=%.so)
  RAMDISK_LIB_FILES=$(SO_TARGET)
  L_OBJS_$(SO_TARGET)=$(A_TARGET)
  SO_CFLAGS=-Wl,--whole-archive
endif

CREATE_LOCAL=$(A_TARGET)

$(call RGDEP,$(SO_TARGET),$(A_TARGET))

EXPORT_HEADERS= crypto.h tmdiff.h opensslv.h opensslconf.h ebcdic.h \
	symhacks.h md32_common.h ossl_typ.h
INTERNAL_HEADERS=cryptlib.h o_time.h o_str.h o_dir.h crypto_stubs.c LPdir_unix.c
CD_EXPORTED_FILES=crypto_env.mak

EXPORT_LIBS=$(LOCAL_A_TARGET)
ifdef CONFIG_DYN_LINK
EXPORT_LIBS+=$(SO_TARGET)
else
EXPORT_LIBS+=$(A_TARGET)
endif

include $(RGMK)

archconfig:: buildinf.h

buildinf.h: $(PWD_SRC)/Makefile
	( echo "#ifndef MK1MF_BUILD"; \
	echo "  /* auto-generated by crypto/Makefile.ssl for crypto/cversion.c */"; \
	echo "  #define CFLAGS \"$(CC) $(CFLAG)\""; \
	echo "  #define PLATFORM \"$(PLATFORM)\""; \
	echo "  #define DATE \"`LC_ALL=C LC_TIME=C date`\""; \
	echo "#endif" ) >buildinf.h

