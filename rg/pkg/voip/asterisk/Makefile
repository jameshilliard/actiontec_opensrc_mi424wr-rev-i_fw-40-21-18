RGSRC=../../..
include $(RGSRC)/envir.mak
include $(RGSRC)/pkg/voip/asterisk/common.mak

FIRST_TASKS+=include/asterisk/version.h
FIRST_TASKS+=include/asterisk/build.h
ARCHCONFIG_FIRST_TASKS+=delete_h_files prototypes.h ast_modules.h

delete_h_files:
	@rm prototypes.h ast_modules.h || true

prototypes.h:
ifdef IS_BUILDDIR
	@echo "/* This file is automatically generated */" > $@
endif
ast_modules.h:
ifdef IS_BUILDDIR
	@echo "/* This file is automatically generated */" > $@
endif
	
ASTERISK_BUILDDIR=$(BUILDDIR)/pkg/voip/asterisk

TARGET=asterisk
RAMDISK_BIN_FILES+=$(TARGET)

LDFLAGS+=-L$(ASTERISK_BUILDDIR) -L$(BUILDDIR)/pkg/lib -lm \
  -lresolv $(ASTERISK_BUILDDIR)/db1-ast/libdb1.a \
  $(ASTERISK_BUILDDIR)/stdtime/libtime.a  \
  $(ASTERISK_BUILDDIR)/editline/editline.a -lm -lresolv \
  -lopenrg_gpl -Wl,-E -lpthread -Lres -lres -Lchannels -lchannels \
  -Lapps -lapps -Lpbx -lpbx
  
ifdef CONFIG_RG_VOIP_ASTERISK_H323
  LDFLAGS+=-lh323_linux_r -lpt_linux_r -ldl \
    $(if $(CONFIG_ULIBC),-luClibc++,-lstdc++)
endif

ifdef CONFIG_ZAPTEL
  LDFLAGS+=-ltonezone
endif

CFLAGS+=-DUSE_DEPRECATED_G726 -DT38_SUPPORT -DZAPTEL_OPTIMIZATIONS

O_OBJS=io.o sched.o logger.o frame.o loader.o config.o channel.o \
  translate.o file.o say.o cli.o pbx.o md5.o term.o \
  ulaw.o alaw.o callerid.o fskmodem.o image.o app.o \
  cdr.o tdd.o acl.o rtp.o udptl.o manager.o asterisk.o ast_expr2.o \
  dsp.o chanvars.o indications.o autoservice.o db.o privacy.o \
  astmm.o enum.o srv.o dns.o aescrypt.o aestab.o aeskey.o \
  utils.o dnsmgr.o plc.o devicestate.o ast_expr2f.o slinfactory.o \
  buildinfo.o

ifdef CONFIG_HW_DSP
  O_OBJS+=jdsp_common.o
endif

SUBDIRS=res pbx apps stdtime db1-ast channels editline

ifdef CONFIG_RG_PBX
  SUBDIRS+=formats sounds codecs funcs
  LDFLAGS+=-Lcodecs -lcodecs -Lfuncs -lfuncs -Lformats -lformats
endif

YFLAGS+=--name-prefix=ast_yy

include/asterisk/version.h: ./build_tools/make_version_h
	$(MKDIR) $(@D)
	$< > $@.tmp
	if cmp -s $@.tmp $@ ; then echo ; else \
		mv $@.tmp $@ ; \
	fi
	rm -f $@.tmp

include/asterisk/build.h: ./build_tools/make_build_h 
	$< > $@.tmp
	if cmp -s $@.tmp $@ ; then echo ; else \
		mv $@.tmp $@ ; \
	fi
	rm -f $@.tmp

CLEAN+=include/asterisk/version.h include/asterisk/build.h ast_expr.c

RAMDISK_LAST_TASKS+=asterisk_ramdisk
asterisk_ramdisk:
ifdef IS_BUILDDIR
	$(RG_MKDIR) $(RAMDISK_RW_DIR)$(ASTVARRUNDIR)
	$(RG_MKDIR) $(RAMDISK_RW_DIR)$(ASTSPOOLDIR)/voicemail
	$(RG_MKDIR) $(RAMDISK_RW_DIR)$(ASTSPOOLDIR)/tmp
	$(RG_MKDIR) $(RAMDISK_RW_DIR)$(ASTVARLIBDIR)
	$(RG_MKDIR) $(RAMDISK_RW_DIR)$(ASTETCDIR)
endif

ifeq ($(CONFIG_RG_SYSLOG_GLIBC),y)
    CFLAGS += -include $(RGSRC)/pkg/syslog/glibc/ulibc_syslog.h
    LDFLAGS += -L$(RGSRC)/pkg/syslog/glibc/
    LDLIBS:=-lresolv -lulibc_syslog $(LDLIBS)
endif

include $(RGMK)

